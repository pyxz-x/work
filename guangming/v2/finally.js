const { encrypt_mouse } = require('./tw.js');

function hash(text) {
    var arr = []
    for (let i = 0; i < 16; i++) {
        arr.push((i << 4) + (i % 16))
    }
    for (let i = 0, a = 0, d, c, b; i < 16; i++) {
        d = (i + a + arr[i] + arr[a]) >>> 1
        b = '0000'.charCodeAt(-(-i % 4))
        a = (d + b) & 15
        c = arr[i]
        arr[i] = arr[a], arr[a] = c
    }
    for (let i = 0, m, n = 0, a, b, c;
        i < text.length; i++) {
        m = i & 15
        a = m ^ n
        b = arr[m] ^ arr[n]
        n = (a + b) & 15
        c = arr[m]
        arr[m] = arr[n], arr[n] = c
        c = text.charCodeAt(i) + (m + n)
        c ^= (arr[m] ^ arr[n])
        c &= 255
        arr[m] = c
    }
    console.log(arr)
    for (let d, o = 0, r = 0; o < 32; o++) {
        d = arr[r] ^ arr[r ? r - 1 : 15]
        arr[r] = d, r++
        if (r > 15) {
            r = 0
        }
    }
    const r = arr.map(num => num.toString(16).padStart(2, '0')).join('')
    return r + text
}
function arg(id) {
    let r = ''
        , key = "hhucaoj8vhp4la04" // 暂时不清楚怎么来的，可能是随机
        , arr = [32, 50, 10, 51, 6, 44, 37, 16, 46, 11, 62, 19, 43, 25, 23, 30, 60, 33, 53, 34, 7, 26, 12, 48, 5, 2, 20, 4, 61, 13, 47, 49, 18, 29, 27, 22, 1, 17, 39, 56, 41, 38, 55, 31, 15, 58, 52, 40, 8, 57, 45, 35, 59, 36, 42, 54, 63, 3, 24, 28, 14, 9, 0, 21]
    for (let o = 0, t = 0, a, b = []; o < arr.length; o++) {
        a = (o + t) + arr[o], b.push((a + arr[t]) >> 1)
        a = b.pop(), b.push(a + key.charCodeAt(o % key.length))
        a = b.pop()
        if (o != (t = a & 63)) {
            arr[o] = arr[o] ^ arr[t]
            arr[t] = arr[o] ^ arr[t]
            arr[o] = arr[o] ^ arr[t]
        } else {
            continue
        }
    }
    for (let o = a = 0, b, m, c = []; o < id.length; o++) {
        b = (o ^ a) + (arr[o] ^ arr[a])
        if (o != (a = b & 63)) {
            arr[o] = arr[o] ^ arr[a]
            arr[a] = arr[o] ^ arr[a]
            arr[o] = arr[o] ^ arr[a]
        }
        m = id.charCodeAt(o), c.push(m + (o + arr[o]))
        m = c.pop(), c.push(m - (a + arr[a]))
        m = c.pop(), c.push(m ^ (arr[o] + arr[a]), arr[o], arr[a])
        m = c.pop(), b = c.pop(), c.push(m + b)
        m = c.pop(), c.push(arr[m & 63])
        m = c.pop(), b = c.pop(), c.push(m ^ b)
        r += String.fromCharCode(c.pop() & 255)
    }
    return btoa(r)
}
function encrypt(t) {
    function b(A, d) {
        return ((A * -20) - (d * -20)) / -20
    }
    function c(A, d) {
        return ~(~A | ~d)
    }
    function D(A, d) {
        return (A & ~d) | (~A & d)
    }
    function e(A, d) {
        return A + d
    }
    // 数组暂时可以固定
    var r = ''
        , s = {
            a: 0,
            e: 0,
            n: 0,
        }
        , n = [s['e'], 1], d, A
        , arr = [35, 21, 29, 51, 50, 31, 6, 40, 18, 7, 38, 36, 4, 59, 58, 23, 9, 26, 2, 10, 46, 15, 41, 1, 16, 43, 45, 17, 44, 3, 52, 14, 60, 39, 28, 12, 32, 13, 8, 34, 37, 53, 11, 22, 24, 19, 30, 25, 63, 57, 61, 56, 62, 0, 5, 33, 48, 20, 27, 47, 54, 49, 55, 42]
        , str = encrypt_mouse(t)
    for (; s['n'] < str.length - 1;) {
        s['n'] += 1
        d = n.pop(), A = n.pop(), n.push(s['e'] = c(A + d, 63), s['a'])
        d = n.pop(), A = n.pop(), n.push(D(A, d), arr[s['e']], arr[s['a']])
        d = n.pop(), A = n.pop(), n.push(D(A, d))
        d = n.pop(), A = n.pop(), n.push(A + d, 63)
        d = n.pop(), A = n.pop(), s['a'] = c(A, d)
        if (s['e'] != s['a']) {
            d = n.pop(), A = n.pop(), n.push(arr[s['e']], arr[s['a']])
            d = n.pop(), A = n.pop(), n.push(arr[s['e']] = D(A, d), arr[s['a']])
            d = n.pop(), A = n.pop(), n.push(arr[s['e']], arr[s['a']] = D(A, d))
            d = n.pop(), A = n.pop(), n.push(str.charCodeAt(s['n']), s['e'], arr[s['e']] = D(A, d))
            d = n.pop(), A = n.pop(), n.push(e(A, d))
            d = n.pop(), A = n.pop(), n.push(e(A, d), s['a'], arr[s['a']])
            d = n.pop(), A = n.pop(), n.push(e(A, d))
            d = n.pop(), A = n.pop(), n.push(b(A, d), arr[s['e']], arr[s['a']])
            d = n.pop(), A = n.pop(), n.push(e(A, d))
            d = n.pop(), A = n.pop(), n.push(D(A, d), arr[s['e']], arr[s['a']])
            d = n.pop(), A = n.pop(), n.push(e(A, d), 63)
            d = n.pop(), A = n.pop(), n.push(arr[c(A, d)])
            d = n.pop(), A = n.pop(), n.push(c(D(A, d), 255))
        } else {
            n.push(str.charCodeAt(s['n']), s['e'], arr[s['e']])
            d = n.pop(), A = n.pop(), n.push(A + d)
            d = n.pop(), A = n.pop(), n.push(A + d, s['a'], arr[s['a']])
            d = n.pop(), A = n.pop(), n.push(A + d)
            d = n.pop(), A = n.pop(), n.push(b(A, d), arr[s['e']], arr[s['a']])
            d = n.pop(), A = n.pop(), n.push(A + d)
            d = n.pop(), A = n.pop(), n.push(D(A, d), arr[s['e']], arr[s['a']])
            d = n.pop(), A = n.pop(), n.push(e(A, d), 63)
            d = n.pop(), A = n.pop(), n.push(arr[c(A, d)])
            d = n.pop(), A = n.pop(), n.push(c(D(A, d), 255))
        }
        r += String.fromCharCode(n.pop())
        n.push(s['e'], 1)
        if (s['e'] >= 63) {
            s['e'] = 0
        }
    }
    return btoa('%' + r)
}

function get_data(id) {
    // id：网页返回
    var t1 = Date.now(),
        t = {
            "TrackList": {
                "mc": "520,308,14413, ,1",
                "tc": "",
                "mu": "",
                "te": "",
                "mp": "390,797,13209,1|390,797,13210,1|389,797,13296,1|389,796,13331,1|391,795,13331,1|396,794,13334,1|402,792,13334,1|409,790,13335,1|419,784,13337,1|428,779,13339,1|441,772,13341,1|452,764,13343,1|462,756,13345,1|475,751,13347,1|485,744,13349,1|498,736,13351,1|511,727,13353,1|520,719,13355,1|527,713,13358,1|537,707,13359,1|547,701,13361,1|553,697,13363,1|559,691,13365,1|567,686,13367,1|573,683,13368,1|579,678,13371,1|582,674,13373,1|585,672,13375,1|586,668,13376,1|588,665,13378,1|589,663,13380,1|590,661,13382,1|592,658,13384,1|593,656,13386,1|594,654,13388,1|595,652,13391,1|595,651,13392,1|595,650,13394,1|596,648,13396,1|597,647,13398,1|597,646,13400,1|598,642,13402,1|598,639,13404,1|598,636,13406,1|599,633,13408,1|600,631,13410,1|601,628,13414,1|601,625,13418,1|601,623,13419,1|602,622,13421,1|603,620,13424,1|603,619,13425,1|603,618,13427,1|604,615,13429,1|606,613,13431,1|606,612,13433,1|609,608,13435,1|611,605,13437,1|613,602,13439,1|614,599,13444,1|614,596,13445,1|616,593,13448,1|617,591,13449,1|617,590,13451,1|617,588,13453,1|619,587,13455,1|620,586,13458,1|620,584,13459,1|621,582,13460,1|621,579,13464,1|621,576,13466,1|621,574,13468,1|621,573,13470,1|621,570,13475,1|621,568,13476,1|621,567,13478,1|621,566,13482,1|621,564,13486,1|621,562,13488,1|621,560,13491,1|621,559,13493,1|621,558,13495,1|621,556,13500,1|621,554,13504,1|621,552,13508,1|621,551,13513,1|621,550,13514,1|621,548,13516,1|621,547,13517,1|621,546,13517,1|621,544,13522,1|621,543,13523,1|621,542,13525,1|621,533,13538,1|621,527,13539,1|621,522,13541,1|621,519,13543,1|621,517,13546,1|621,514,13558,1|621,513,13590,1|621,512,13592,1|621,511,13596,1|621,508,13600,1|621,506,13601,1|621,505,13604,1|621,504,13605,1|622,501,13608,1|623,498,13609,1|623,495,13611,1|623,493,13613,1|623,490,13616,1|624,487,13618,1|624,484,13619,1|624,482,13621,1|624,479,13624,1|625,476,13628,1|626,473,13630,1|626,470,13630,1|628,465,13633,1|629,462,13634,1|629,459,13636,1|629,457,13638,1|629,454,13642,1|629,449,13642,1|629,446,13644,1|629,443,13646,1|629,440,13648,1|629,436,13650,1|629,433,13652,1|629,428,13660,1|629,425,13661,1|629,422,13662,1|629,419,13664,1|629,416,13666,1|629,414,13668,1|629,412,13670,1|629,410,13672,1|629,409,13675,1|629,407,13675,1|629,406,13677,1|629,404,13679,1|629,402,13681,1|629,401,13683,1|629,399,13685,1|629,397,13687,1|629,395,13689,1|629,394,13691,1|629,392,13693,1|629,391,13695,1|628,388,13697,1|627,386,13699,1|627,384,13701,1|627,382,13703,1|626,379,13705,1|625,377,13708,1|624,375,13709,1|623,374,13711,1|623,372,13713,1|623,370,13715,1|622,367,13716,1|620,365,13718,1|619,363,13720,1|618,362,13722,1|617,360,13724,1|615,357,13726,1|615,356,13728,1|613,355,13730,1|612,353,13732,1|610,351,13734,1|609,348,13736,1|607,346,13738,1|606,344,13741,1|605,343,13743,1|604,340,13744,1|602,337,13746,1|601,335,13748,1|599,334,13750,1|598,332,13753,1|597,331,13755,1|596,329,13757,1|595,328,13761,1|594,325,13764,1|592,323,13765,1|591,321,13767,1|589,319,13769,1|588,316,13771,1|586,315,13773,1|586,314,13776,1|583,310,13777,1|582,308,13779,1|580,306,13781,1|579,304,13783,1|577,301,13785,1|576,300,13787,1|575,299,13790,1|568,291,13792,1|564,286,13793,1|563,283,13795,1|561,281,13797,1|559,280,13799,1|557,278,13806,1|554,278,13809,1|552,277,13812,1|549,275,13815,1|548,274,13821,1|547,273,13823,1|546,272,13827,1|545,272,13870,1|543,272,13872,1|542,272,13876,1|541,272,13887,1|539,272,13934,1|538,272,13940,1|537,272,13946,1|535,272,13949,1|534,273,13951,1|533,274,13955,1|531,274,13960,1|530,275,13961,1|529,276,13965,1|527,277,13970,1|526,278,13975,1|524,279,13978,1|523,279,13980,1|522,280,13985,1|520,281,13999,1|519,283,14012,1|518,283,14026,1|517,284,14054,1|517,285,14067,1|517,286,14070,1|517,288,14074,1|517,289,14080,1|517,290,14084,1|517,292,14088,1|517,293,14094,1|517,294,14096,1|517,295,14100,1|517,297,14105,1|517,298,14109,1|517,299,14109,1|517,301,14120,1|516,302,14128,1|516,303,14132,1|515,305,14137,1|514,306,14143,1|514,307,14153,1|514,309,14160,1|514,310,14172,1|515,310,14325,1|516,310,14329,1|518,310,14337,1|519,309,14355,1|520,308,14382,1|520,307,14505,1|518,304,14507,1|518,302,14510,1|519,301,14511,1|522,300,14514,1|526,300,14515,1|529,300,14518,1|532,300,14519,1|534,300,14521,1|536,300,14523,1|539,300,14528,1|544,300,14529,1|549,300,14531,1|556,300,14533,1|566,300,14535,1|576,300,14537,1|585,300,14540,1|592,300,14542,1|600,300,14544,1|614,300,14545,1|626,300,14547,1|637,300,14549,1|650,300,14551,1|658,300,14553,1|669,300,14554,1|680,301,14557,1|698,301,14558,1|711,302,14560,1|723,303,14563,1|735,303,14564,1|754,305,14566,1|769,307,14568,1|781,309,14570,1|792,310,14572,1|812,311,14574,1|830,314,14576,1|845,316,14578,1|859,319,14580,1",
                "tmv": "",
                "mm": "520,308,14413,1|520,307,14506,1|518,304,14507,1|518,302,14510,1|519,301,14511,1|522,300,14515,1|526,300,14515,1|529,300,14518,1|532,300,14519,1|534,300,14521,1|536,300,14523,1|539,300,14528,1|544,300,14529,1|549,300,14531,1|556,300,14533,1|566,300,14535,1|576,300,14537,1|585,300,14540,1|592,300,14542,1|600,300,14544,1|614,300,14546,1|626,300,14547,1|637,300,14549,1|650,300,14551,1|658,300,14553,1|669,300,14554,1|680,301,14557,1|698,301,14558,1|711,302,14560,1|723,303,14563,1|735,303,14564,1|754,305,14566,1|769,307,14568,1|781,309,14570,1|792,310,14572,1|812,311,14574,1|830,314,14576,1|845,316,14578,1|859,319,14580,1|988,367,14597,1",
                "ks": "",
                "fi": "",
                "startTime": 1756455280045,
                "si": "1243,1920,938,1243,938,1030,1080,60.532687651604725,1314"
            },
            "TrackStartTime": t1,
            "VerifyTime": t1 + 14586,
            "arg": arg(id)
        }
    var h = hash(JSON.stringify(t))
    return encrypt(h)
}
console.log(get_data(1234565))

module.exports = {
    get_finally_data: get_data
}



